# ************************************************************************************************
# Warning: YAML source code for Canvas Apps should only be used to review changes made within Power Apps Studio and for minor edits (Preview).
# Use the maker portal to create and edit your Power Apps.
# 
# The schema file for Canvas Apps is available at https://go.microsoft.com/fwlink/?linkid=2304907
# 
# For more information, visit https://go.microsoft.com/fwlink/?linkid=2292623
# ************************************************************************************************
Screens:
  scrLanding:
    Properties:
      Fill: =RGBA(248, 249, 250, 1)
      LoadingSpinnerColor: =RGBA(56, 96, 178, 1)
      OnVisible: "=// scrLanding.OnVisible\r\n// 1. Get user info from global variables (set in App.OnStart)\r\nSet(varUserEmail, gblUserEmail);\r\nSet(varUserName, gblUserName);\r\n\r\n// 2. Count pending evaluations for this user\r\nClear(colPending);\r\nCollect(\r\n    colPending,\r\n    Filter(ongoingEvaluations,\r\n        email_responsable_tecnico = varUserEmail &&\r\n        tecnico_submitted = false\r\n    )\r\n);\r\nCollect(\r\n    colPending,\r\n    Filter(ongoingEvaluations,\r\n        email_responsable_sst = varUserEmail &&\r\n        responsable_sst_responde = true &&\r\n        sst_submitted = false\r\n    )\r\n);\r\nCollect(\r\n    colPending,\r\n    Filter(ongoingEvaluations,\r\n        email_responsable_ma = varUserEmail &&\r\n        responsable_ma_responde = true &&\r\n        ma_submitted = false\r\n    )\r\n);\r\nCollect(\r\n    colPending,\r\n    Filter(ongoingEvaluations,\r\n        email_jefe_area = varUserEmail &&\r\n        aprobada = false &&\r\n        tecnico_submitted = true &&\r\n        sst_submitted = true &&\r\n        ma_submitted = true\r\n    )\r\n);\r\nSet(varPendingCount, CountRows(Distinct(colPending, ID)));\r\n\r\n\r\n/*\r\nSet(\r\n    varPendingCount,\r\n    CountIf(\r\n        ongoingEvaluations,\r\n        (\r\n            // 1. Técnico: sees rejected items OR items they haven't submitted yet\r\n            (email_responsable_tecnico = varUserEmail && !tecnico_submitted) ||\r\n            \r\n            // 2. SST: sees non-rejected items where they are responsible and haven't submitted\r\n            (email_responsable_sst = varUserEmail && responsable_sst_responde && !sst_submitted) ||\r\n            \r\n            // 3. MA: sees non-rejected items where they are responsible and haven't submitted\r\n            (email_responsable_ma = varUserEmail && responsable_ma_responde && !ma_submitted) ||\r\n            \r\n            // 4. Approver: sees items ready for approval\r\n            (\r\n                email_jefe_area = varUserEmail && \r\n                !aprobada && \r\n                tecnico_submitted && sst_submitted && ma_submitted\r\n            )\r\n        )\r\n    )\r\n);*/\r\n\r\n/*// 2. Count pending evaluations for this user\r\nSet(\r\n    varPendingCount,\r\n    CountIf(\r\n        ongoingEvaluations,\r\n        (\r\n            // 1. Técnico: sees rejected items OR items where their mandatory sections are incomplete\r\n            (\r\n                email_responsable_tecnico = varUserEmail && \r\n                (\r\n                    rechazada || \r\n                    !(\r\n                        !IsBlank(calificacion_criterio_calidad) &&\r\n                        !IsBlank(calificacion_criterio_oportunidad) &&\r\n                        !IsBlank(calificacion_criterio_gestion) &&\r\n                        (responsable_sst_responde || !IsBlank(calificacion_criterio_sst)) &&\r\n                        (responsable_ma_responde || !IsBlank(calificacion_criterio_ma))\r\n                    )\r\n                )\r\n            ) ||\r\n            \r\n            // 2. SST: sees non-rejected items where they are responsible and their section is blank\r\n            (\r\n                email_responsable_sst = varUserEmail && \r\n                responsable_sst_responde && \r\n                !rechazada && \r\n                IsBlank(calificacion_criterio_sst)\r\n            ) ||\r\n            \r\n            // 3. MA: sees non-rejected items where they are responsible and their section is blank\r\n            (\r\n                email_responsable_ma = varUserEmail && \r\n                responsable_ma_responde && \r\n                !rechazada && \r\n                IsBlank(calificacion_criterio_ma)\r\n            ) ||\r\n            \r\n            // 4. Approver: sees items ready for approval (all sections done, not approved/rejected yet)\r\n            (\r\n                email_jefe_area = varUserEmail && \r\n                (\r\n                    !aprobada && !rechazada &&\r\n                    !IsBlank(calificacion_criterio_calidad) &&\r\n                    !IsBlank(calificacion_criterio_oportunidad) &&\r\n                    !IsBlank(calificacion_criterio_gestion) &&\r\n                    (!responsable_sst_responde || !IsBlank(calificacion_criterio_sst)) &&\r\n                    (!responsable_ma_responde || !IsBlank(calificacion_criterio_ma))\r\n                )\r\n            )\r\n        ) &&\r\n        // Overall filter: only show items that are not yet approved, or are rejected (for Técnico to action)\r\n        (!aprobada || rechazada)\r\n    )\r\n);\r\n*/"
    Children:
      - conHeader:
          Control: GroupContainer@1.3.0
          Variant: ManualLayout
          Properties:
            Fill: =ColorValue("#003087")
            Height: =100
            Width: =Parent.Width
          Children:
            - conHeaderContent:
                Control: GroupContainer@1.3.0
                Variant: AutoLayout
                Properties:
                  DropShadow: =DropShadow.None
                  Height: =Parent.Height
                  LayoutAlignItems: =LayoutAlignItems.Center
                  LayoutDirection: =LayoutDirection.Horizontal
                  LayoutGap: =20
                  LayoutJustifyContent: =LayoutJustifyContent.SpaceBetween
                  PaddingBottom: =8
                  PaddingLeft: =40
                  PaddingRight: =40
                  PaddingTop: =8
                  Width: =Parent.Width
                Children:
                  - imgLogo:
                      Control: Image@2.2.3
                      Properties:
                        BorderColor: =RGBA(0, 18, 107, 1)
                        Height: =150
                        Image: =logo2
                        Width: =150
                        X: =60
                  - conMenuGroup:
                      Control: GroupContainer@1.3.0
                      Variant: AutoLayout
                      Properties:
                        DropShadow: =DropShadow.None
                        LayoutAlignItems: =LayoutAlignItems.Center
                        LayoutDirection: =LayoutDirection.Horizontal
                        LayoutGap: =40
                        LayoutJustifyContent: =LayoutJustifyContent.End
                        LayoutMaxHeight: =0
                        LayoutMaxWidth: =0
                        LayoutMinHeight: =16
                        LayoutMinWidth: =16
                        PaddingBottom: =8
                        PaddingLeft: =8
                        PaddingRight: =8
                        PaddingTop: =8
                        Width: =Parent.Width - imgLogo.Width
                      Children:
                        - btnEvaluateProviders:
                            Control: CanvasComponent
                            ComponentName: cmpHeaderButton
                            Properties:
                              Destination: =scrEvaluations
                              Fill: =Color.Transparent
                              Height: =80
                              IsActive: =App.ActiveScreen = scrEvaluations
                              Label: ="Evaluaciones"
                              Width: =180
                        - btnDashboard:
                            Control: CanvasComponent
                            ComponentName: cmpHeaderButton
                            Properties:
                              Destination: =scrDashboard
                              Fill: =Color.Transparent
                              Height: =80
                              IsActive: =App.ActiveScreen = scrDashboard
                              Label: ="Dashboard"
                              Width: =180
      - lblWelcome:
          Control: Label@2.5.1
          Properties:
            Align: =Align.Center
            BorderColor: =RGBA(0, 18, 107, 1)
            Color: =ColorValue("#003087")
            Font: =Font.'Segoe UI'
            FontWeight: =FontWeight.Bold
            Height: =60
            Size: =24
            Text: |+
              ="Bienvenido/a " & gblUserName & ", tienes " & varPendingCount & " evaluaciones pendientes por completar"
            Width: =Parent.Width
            Y: =300
